<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>人脸识别开放平台</title>
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Bootstrap -->
<link href="css/bootstrap.css" rel="stylesheet" media="screen">
<link href="css/style.css" rel="stylesheet" media="screen">
</head>
<body>
<div class="y_container">
	<div class="y_header">
		<div class="logo"></div>
		<ul class="y_navbar nav pull-right">
			<li><a class="a_nav" href="index.html">首页</a></li>
			<li><a class="a_nav" href="doc.html">文档</a></li>
			<li><a class="a_nav active_nav" href="demo.html">演示</a></li>
			<li><a class="a_nav" href="case.html">案例</a></li>
			<li><a class="a_nav" href="download.html">下载</a></li>
		</ul>
	</div>
	<!--y_header-->
	
	<div class="y_body">
		<ul class="nav nav-tabs y_tab">
			<li><a href="demo.html">人脸检测</a></li>
			<li><a href="demo_2.html">明星脸对比</a></li>
			<li class="active"><a href="#" class="tab_name">人脸相似度</a></li>
		</ul>
		<div class="demo_body_2">
			<div class="y_block y_input_block_3">
				<p>选择上传文件<br />
					<span class="gray">上传图片大小请不要超过1M</p>
				<form id="simi_form" class="form-horizontal" action="/upload_img.cgi?ref=face_compare_demo" method="POST"  enctype="multipart/form-data">
					<div class="input-append">
						<div class="control-group">
							<label class="control-label" for="image_url_1">第一张图片:</label>
							<div class="controls">
								<input class="span4" type="text" id="image_url_1">
								<button class="btn" type="button" id="simi_open_1"> 打开网络图片 </button>
								<button class="btn" type="button" id="simi_upload_1"> 上传本地图片 </button>
								<input type="file" name="imgfile" id="input_image_1"/>
							</div>
						</div>
                </form>
                <form id="simi_form_2" class="form-horizontal" action="/upload_img.cgi?ref=face_compare_demo2" method="POST"  enctype="multipart/form-data">
				
						<div class="control-group">
							<label class="control-label" for="image_url_2">第二张图片:</label>
							<div class="controls">
								<input class="span4" type="text" id="image_url_2">
								<button class="btn" type="button" id="simi_open_2" disabled> 打开网络图片 </button>
								<button class="btn" type="button" id="simi_upload_2"  disabled> 上传本地图片 </button>
								<input type="file" name="imgfile" id="input_image_2"  disabled />
                                <input id="first_img4_submit2" name="img1" type="hidden" value=""  />
							</div>
						</div>
					</div>
				</form>
			</div>
            <div class="y_block_left">
			<div class="thumbnail" id="imgDivSimi1" >
				<div id="imgDiv1">
					<div id="loading1" class="loading"></div>
					<img id="resultImg1"></img> </div>
			</div>
			<div class="thumbnail" id="imgDivSimi2" >
				<div id="imgDiv2">
					<div id="loading2" class="loading"></div>
					<img id="resultImg2"></img> </div>
			</div>
            <div class="clearfix"></div>
            </div>
			<div class="y_block_results">
			<div id="simi_result_1"></div>
			<div id="simi_result_2"></div>
            <div class="clearfix"></div>
			</div>
			<div class="y_block_buttom_3">
				<div class="y_result_table">
					<table class="table table-striped" >
						<thead>
							<tr>
								<th>图一中的人脸</th>
								<th>图二中的人脸</th>
								<th>相似度</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
				<div class="bs-docs-json" id="imgJson2" >服务器返回的JSON</div>
				<div class="clearfix"></div>
			</div>
			<div class="clearfix"></div>
			<div class="y_block" id="result_2"></div>
			<div class="y_block" id="similar"></div>
		</div>
		<div class="clearfix"></div>
	</div>
	<!--y_body-->
	
	<div class="y_footer"> 关于腾讯 |  服务协议 |  客服中心<br />
		Copyright ©2012-2013 Tencent Inc. All Rights Reserved. </div>
	<!--y_footer--> 
	
</div>
<!--y_container-->
</body>
<script language="javascript" src="js/jquery.js"></script>
<script language="javascript" src="js/json2.js"></script>
<script language="javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript">
      
	 function resetForm() {
		$('#simi_form').each(function(){
	        this.reset();
		});
			$("#simi_open_2").attr('disabled','true');
			$("#simi_upload_2").attr('disabled','true');
			$("#input_image_2").attr('disabled','true');
	}
	
	function resetResult(){
		$('#append_img1').remove();
		$("#simi_result_1").html('');
		$("#simi_result_2").html('');
		$("#imgJson2").html('服务器返回的JSON').height(30);
		$("tbody").empty();
		$('#resultImg2').hide();
		$('#resultImg1').hide();
		$('#loading1').css('background-image',"url(./img/wfu.png)").show();
		$('#loading2').css('background-image',"url(./img/wfu.png)").show();
		$('.face_rect').remove();
		$('.dot_rect').remove();
	}
    
    
    function func_success_image_1(json){
        
        var img = $('#resultImg1');
        $("#simi_result_1").html('<div class="alert alert-success"> <strong>第一张图片检测成功</strong>&nbsp;&nbsp;检测到'+json.face.length+'张人脸 </div>'); 
		  		
		var oImgW = json.img_width;
        var oImgH = json.img_height;
		var scale = 1.0;
		  
        if( oImgW > oImgH ) {
            if (oImgW > max_width) {
				scale = (max_width/oImgW);
				img.width(max_width);
				img.height(scale*oImgH);
            }else{
				img.width(oImgW);
				img.height(oImgH);
            }
        }else{
            if (oImgH > max_height) {
				scale = (max_height/oImgH);
				img.height(max_height);
				img.width(oImgW*scale);                     
            }else{
				img.width(oImgW);
				img.height(oImgH);
            }             
        }
        
        
		img.attr('src',json.url);
        $('#loading1').hide();
		img.show();
		       
        for(var j=0;j<json.face.length;j++){ 
            var faceDiv = $('<div class="face_rect"></div>'); 
			faceDiv.css('left',json.face[j].topleftX*scale);    
			faceDiv.css('top',json.face[j].topleftY*scale);
			faceDiv.width(json.face[j].width*scale);  
			faceDiv.height(json.face[j].height*scale); 
				
			faceDiv.popover({
				title:"Face Information",
				content:"width:"+json.face[j].width+"px\n height:"+json.face[j].height+"px\ntopleftX:"+json.face[j].topleftX+"px\ntopleftY:"+json.face[j].topleftY+"px",
				trigger:"hover"
			});  
				
			$('#imgDiv1').append(faceDiv);   
				                              
                
			if(json.face[j].eyes.yleft!=0 && json.face[j].eyes.xleft!=0){
				var leye = $('<div class="dot_rect"></div>');
                leye.css('left',json.face[j].eyes.xleft*scale);    
				leye.css('top',json.face[j].eyes.yleft*scale);
				$('#imgDiv1').append(leye);                            
            }
				 
			
            if(json.face[j].eyes.yright!=0 && json.face[j].eyes.xright!=0){
				var reye = $('<div class="dot_rect"></div>');
                reye.css('left',json.face[j].eyes.xright*scale);    
				reye.css('top',json.face[j].eyes.yright*scale);
				$('#imgDiv1').append(reye);                            
            }
				 
			if(json.face[j].mouth.yleft!=0 && json.face[j].mouth.xleft!=0){
				var lmouth = $('<div class="dot_rect"></div>');
                lmouth.css('left',json.face[j].mouth.xleft*scale);    
				lmouth.css('top',json.face[j].mouth.yleft*scale);
                $('#imgDiv1').append(lmouth);                            
            }
				 
			if(json.face[j].mouth.yright!=0 && json.face[j].mouth.xright!=0){
				var rmouth = $('<div class="dot_rect"></div>');
                rmouth.css('left',json.face[j].mouth.xright*scale);    
                rmouth.css('top',json.face[j].mouth.yright*scale);
				$('#imgDiv1').append(rmouth);                            
            }
		}    
    }
    
    function func_success_image_2(json){
    
        var img = $('#resultImg2');
        $("#simi_result_2").html('<div class="alert alert-success"> <strong>第二张图片检测成功</strong>&nbsp;&nbsp;检测到'+json.face2.length+'张人脸 </div>'); 
		  		
		var oImgW = json.img_width2;
        var oImgH = json.img_height2;
		var scale = 1.0;
		  
        if( oImgW > oImgH ) {
            if (oImgW > max_width) {
				scale = (max_width/oImgW);
				img.width(max_width);
				img.height(scale*oImgH);
            }else{
				img.width(oImgW);
				img.height(oImgH);
            }
        }else{
            if (oImgH > max_height) {
				scale = (max_height/oImgH);
				img.height(max_height);
				img.width(oImgW*scale);                     
            }else{
				img.width(oImgW);
				img.height(oImgH);
            }             
        }
        
        
		img.attr('src',json.url2);
        $('#loading2').hide();
		img.show();
		       
        for(var j=0;j<json.face2.length;j++){ 
            var faceDiv = $('<div class="face_rect"></div>'); 
			faceDiv.css('left',json.face2[j].topleftX*scale);    
			faceDiv.css('top',json.face2[j].topleftY*scale);
			faceDiv.width(json.face2[j].width*scale);  
			faceDiv.height(json.face2[j].height*scale); 
				
			faceDiv.popover({
				title:"Face Information",
				content:"width:"+json.face2[j].width+"px\n height:"+json.face2[j].height+"px\ntopleftX:"+json.face2[j].topleftX+"px\ntopleftY:"+json.face2[j].topleftY+"px",
				trigger:"hover"
			});  
				
			$('#imgDiv2').append(faceDiv);   
				                              
                
			if(json.face2[j].eyes.yleft!=0 && json.face2[j].eyes.xleft!=0){
				var leye = $('<div class="dot_rect"></div>');
                leye.css('left',json.face2[j].eyes.xleft*scale);    
				leye.css('top',json.face2[j].eyes.yleft*scale);
				$('#imgDiv2').append(leye);                            
            }
				 
			
            if(json.face2[j].eyes.yright!=0 && json.face2[j].eyes.xright!=0){
				var reye = $('<div class="dot_rect"></div>');
                reye.css('left',json.face2[j].eyes.xright*scale);    
				reye.css('top',json.face2[j].eyes.yright*scale);
				$('#imgDiv2').append(reye);                            
            }
				 
			if(json.face2[j].mouth.yleft!=0 && json.face2[j].mouth.xleft!=0){
				var lmouth = $('<div class="dot_rect"></div>');
                lmouth.css('left',json.face2[j].mouth.xleft*scale);    
				lmouth.css('top',json.face2[j].mouth.yleft*scale);
                $('#imgDiv2').append(lmouth);                            
            }
				 
			if(json.face2[j].mouth.yright!=0 && json.face2[j].mouth.xright!=0){
				var rmouth = $('<div class="dot_rect"></div>');
                rmouth.css('left',json.face2[j].mouth.xright*scale);    
                rmouth.css('top',json.face2[j].mouth.yright*scale);
				$('#imgDiv2').append(rmouth);                            
            }
		}


//compare table
            for(var i = 0; i < json.face.length; i++ ){
                    for(var j=0;j<json.face2.length;j++){
						
						var face_width_1 = json.face[i].width;
						var scale_1 = 100.0/face_width_1; 
						//100=frame width
						var offset_left_1 = -scale_1*json.face[i].topleftX;
						var offset_top_1 = -scale_1*json.face[i].topleftY;
						var width_1 = json.img_width*scale_1;
						
						var face_width_2 = json.face2[j].width;
						var scale_2 = 100.0/face_width_2; 
						//100=frame width
						var offset_left_2 = -scale_2*json.face2[j].topleftX;
						var offset_top_2 = -scale_2*json.face2[j].topleftY;
						var width_2 = json.img_width2*scale_2
						
						var score = json.scores[i][j]*100;
						
						
						var similar_line = '<tr><td><div class="simi_rect"><img src="'+json.url+'" class="simi_face_img" style="width:'+width_1+'px;left:'+offset_left_1+'px;top:'+offset_top_1+'px"></img></div></td>';
						similar_line += '<td><div class="simi_rect"><img src="'+json.url2+'" class="simi_face_img" style="width:'+width_2+'px;left:'+offset_left_2+'px;top:'+offset_top_2+'px"></img></div></td>';
						similar_line += '<td><h5><span class="red_colored">'+score.toFixed(2)+'%</h5></td></tr>';
		
						$('tbody').append(similar_line);
					}
			}

            $('#imgJson2').html(JSON.stringify(json,null,2));            
    }
   

	function func_open_image_1(){
		
			$('#loading1').css('background-image',"url(./img/load.gif)");
			
			var enurl = $("#image_url_1").val();
			var data =  { "url": enurl,"key": "demo_key", "secret": "demo_secret" };
        
        	$.getJSON("http://api.face.pr.qq.com/detection/detect?jsoncallback=?",data,function(json){
				
				
			if( json.ret == 0 ) {
				
				//找到人脸 开启第二张	
				$("#simi_open_2").removeAttr('disabled');
				$("#simi_upload_2").removeAttr('disabled');
				$("#input_image_2").removeAttr('disabled');
                func_success_image_1(json);
                
                $("#first_img4_submit2").attr("value",json.url);
                
			}else{
            
                $('#loading1').css('background-image','url(img/error.png)');
				$("#simi_result_1").html('<div class="alert alert-error"><strong>第一张图片检测失败</strong>&nbsp;&nbsp;错误码为 '+json.ret+'</div>');   
			 
            }
            });
      }
	  
	   function func_open_image_2(){

			$('#loading2').css('background-image',"url(./img/load.gif)");
		
			var img = $('#resultImg2');
			
            var enurl = $("#image_url_1").val();
            var enurl2 = $("#image_url_2").val();
            var data =  { "url": enurl,"url2":enurl2,"key": "demo_key", "secret": "demo_secret" };

            $.getJSON("http://api.face.pr.qq.com/compare?jsoncallback=?",data,function(json){
              
			  if(json.ret == 0){
              
                $('.face_rect').remove();
                $('.dot_rect').remove();
                    
                func_success_image_1(json);
                func_success_image_2(json);
                
                resetForm();
                
                $('#imgJson2').height($('.y_result_table').height());
	
		}else{
				resetForm();
                $('#loading2').css('background-image','url(img/error.png)');
                $('#imgJson2').html(JSON.stringify(json,null,2));
                $("#simi_result_2").html('<div class="alert alert-error"> <strong>第二张图片检测失败</strong>&nbsp;&nbsp;错误码为 '+json.ret+'</div>');
        }
        });
      }

	  
    $(document).ready(function(){
    
        max_width = $('#imgDiv1').width();
	 	max_height = $('#imgDiv1').height();

		$('#simi_open_1').click(function(){
			
			resetResult();
			var image_url = $('#image_url_1').val();
			if(image_url==""){
				alert('请选择一张图片');
        		return false;
			}else{
				var ext = "*.jpg,*.png,*bmp";
        		image_url_ext = image_url.substr(image_url.lastIndexOf("."));
				if(ext.indexOf("*"+image_url_ext)==-1){ 
          			alert("请输入后缀为.jpg、.png、.bmp的图片");
          			return false;  
        		}
			}
		func_open_image_1();
		});
		
		$('#simi_open_2').click(function(){
			var image_url = $('#image_url_2').val();
			if(image_url==""){
				alert('请选择一张图片');
        		return false;
			}else{
				var ext = "*.jpg,*.png,*bmp";
        		image_url_ext = image_url.substr(image_url.lastIndexOf("."));
				if(ext.indexOf("*"+image_url_ext)==-1){ 
          			alert("请输入后缀为.jpg、.png、.bmp的图片");
          			return false;  
        		}
			}
		func_open_image_2();
		});
		
		$('#input_image_1').change(function(){
			
		if (!$('#input_image_1').val().match(/(?:jpg|png|bmp)$/)) {  
            	alert("图片类型必须是jpeg,jpg,png中的一种");                
            return false;  
        }else{ 
            $('#simi_form').submit();
        }
			
		});
		
		
		
		$('#input_image_2').change(function(){
			
		if (!$('#input_image_2').val().match(/(?:jpg|png|bmp)$/)) {  
            alert("图片类型必须是jpeg,jpg,png中的一种");                
            return false;  
        }
		else{ 
            $('#simi_form_2').submit();
        }
			
		});
		
	});
	
	  
</script>
</html>